entities:

  seaf.ba.parties:
    title: Участники

    schema:

      type: object
      patternProperties:
        "[a-zA-Z0-9_]*(\\.[a-zA-Z0-9_]*)*$":
          type: object
          properties:
            title:
              title: Наименование Участника
              description: Юрлицо, Группа, объединение, сегмент, оргединица
              type: string
            has_interest:
              title: Интересующие продукты
              description: Продукты, потребляемые или потенциально интересные Участнику
              type: array
              items:
                type: object
                properties:
                  id:
                    title: Идентификатор продукта
                    $ref: "#/$rels/seaf.ba.products.product"
                required:
                  - id
            accepts:
              title: для
              description: отношение Ресурс - для кого? -> для Участника
              type: array
              items:
                $ref: "#/properties/seaf.ba.resources/$resources"
            feeds:
              title: передает
              description: отношение Участникк -передает или отчуждает что? -> Ресурс
              type: array
              items:
                $ref: "#/properties/seaf.ba.resources/$resources"
            is_part_of:
              title: Является частью
              description: Отношение n к 1 для описания строгих иерархических связей
              $ref: "#/$rels/seaf.ba.parties.party"
            relates_to:
              title: Агрегирующая сущность
              description: Отношение n к m для описания множественных категорий (фасетных признаков)
              type: array
              items:
                $ref: "#/$rels/seaf.ba.parties.party"
          required:
            - title
    objects:
      party:
        route: "/"
        title: Участник
        symbol: "party"

    presentations:

      org_str_wrapper:
        title: Оргструктура
        type: markdown
        template: templates/org_str_wrapper.md

      org_str_graph:
        title: Оргструктура (граф)
        type: smartants
        source: >
          (
            $parties:= $spread($."seaf.ba.parties").[$~>|$.*|{"entity_id": "parties"}|];

            $icons:= $."seaf.icons";
            $pre_nodes:= $parties.$map($, function($v) {(
                $title:= $v.*.title;
                $size:= $length($title);
                $symbol_width:= 25 + ($size > 7 ? $size*14 : $size*16 );
                $symbol:= $getSymbol($title, $v.*.entity_id, $symbol_width, $icons);
                { "nodes": {
                      ($split($v.$keys(), ".")[-1] ? $split($v.$keys(), ".")[-1] : $v.$keys()): {
                          "title": $title, 
                          "symbol": $symbol.title}
                      },
                   "links": $append(
                              $v.*.is_part_of ?
                                [
                                    { "from": ($split($v.$keys(), ".")[-1] ? $split($v.$keys(), ".")[-1] : $v.$keys()),
                                      "to": ($split($v.*.is_part_of, ".")[-1] ? $split($v.*.is_part_of, ".")[-1] : $v.*.is_part_of),
                                      "title": "является частью",
                                      "style": "->"
                                    }

                                ] : [],

                              $map($v.*.relates_to, function($vv) {
                                $vv ?
                                  { "from": ($split($v.$keys(), ".")[-1] ? $split($v.$keys(), ".")[-1] : $v.$keys()),
                                    "to": ($split($vv, ".")[-1] ? $split($vv, ".")[-1] : $vv),
                                    "title": "относится к",
                                    "style": "-[#green]->"
                                  }
                              })
                            ),   

                  "symbols": {
                      $symbol.title: $symbol.svg}
                };
            )});

            {"config": {
              "distance": 10,
              "trackWidth": 24,
              "hideLeafTitles": true
              },
             "symbols": $merge($pre_nodes.symbols), 
             "nodes": $merge($pre_nodes.nodes),
             "links": [$pre_nodes.links]
            } 
          )

